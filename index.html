<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemFlow</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary: #2563eb;
            --surface: #ffffff;
            --bg: #f8fafc;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --premium-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .btn:hover,
        .btn:focus,
        .btn:active {
            box-shadow: none !important;
            outline: none !important;
        }

        .nav-link:hover,
        .nav-link:focus {
            background-color: transparent !important;
        }

        /* HEADER */
        header {
            height: 60px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-main);
        }

        .brand span {
            color: var(--primary);
        }

        .btn {
            background: #fff;
            border: 1px solid #cbd5e1;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* CANVAS */
        .stage {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fff;
            display: flex;
        }

        .scroll-area {
            flex: 1;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-image: linear-gradient(#f1f5f9 1px, transparent 1px), linear-gradient(90deg, #f1f5f9 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .chem-svg {
            display: block;
        }

        /* SVG Styles */
        .reaction-arrow {
            stroke-width: 1.5;
            fill: none;
        }

        .mech-arrow {
            stroke-width: 1;
            opacity: 0.8;
            fill: none;
        }

        .bond {
            stroke-width: 2.5;
            stroke-linecap: round;
            fill: none;
        }

        .bond-wedge {
            stroke: none;
        }

        .bond-dash {
            stroke-dasharray: 5 3;
        }

        .atom-text {
            font-size: 16px;
            font-weight: 600;
            font-family: 'Arial', sans-serif;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .atom-halo {
            fill: #fff;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Arial', sans-serif;
            text-anchor: middle;
            dominant-baseline: middle;
            stroke: #fff;
            stroke-width: 3;
            paint-order: stroke;
        }

        .label-text {
            fill: var(--primary);
            font-size: 16px;
            font-weight: 700;
            text-anchor: start;
        }

        .ts-symbol {
            fill: var(--text-sub);
            font-size: 14px;
            font-weight: bold;
        }

        .bracket {
            stroke: var(--text-main);
            stroke-width: 2;
            fill: none;
        }

        /* MODAL & UI */
        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        .modal-header {
            background: var(--premium-gradient);
            color: white;
            border: none;
            padding: 20px 30px;
        }

        .premium-tabs .nav-link {
            color: #64748b;
            border: none;
            padding: 12px 24px;
            font-weight: 600;
        }

        .premium-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            background: transparent;
        }

        .code-editor {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            background: #1e293b;
            color: #e2e8f0;
            resize: vertical;
        }

        .ai-prompt-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .ai-prompt-text {
            height: 400px;
            font-size: 0.75rem;
            font-family: 'Consolas', monospace;
            resize: vertical;
            background: #1e293b;
            color: #e2e8f0;
            border: none;
        }

        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }

        .custom-toast {
            min-width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left: 4px solid;
            margin-bottom: 10px;
            padding: 15px;
        }

        .toast-success {
            border-left-color: #10b981;
        }

        .toast-error {
            border-left-color: #ef4444;
        }

        .toast-info {
            border-left-color: #3b82f6;
        }
    </style>
</head>

<body>

    <header>
        <div class="brand">Chem <span>Flow</span> <small style="font-size: 0.6em; color: #94a3b8;">by S.A.M.</small></div>
        <div>
            <button class="btn bg-warning" onclick="openModal()">
                <i class="bi bi-database"></i> Studio
            </button>
        </div>
    </header>

    <div class="stage">
        <div class="scroll-area" id="canvas-container"></div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- PREMIUM MODAL -->
    <div class="modal fade" id="dataModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear-fill me-2"></i>Mechanism Designer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter:invert(1)"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs premium-tabs" id="designerTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-designer"><i class="bi bi-magic"></i> AI Designer</button></li>
                        <li class="nav-item"><button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-input"><i class="bi bi-code-square"></i> JSON Input</button></li>
                    </ul>

                    <div class="tab-content" id="designerTabContent" style="padding:20px;">
                        <!-- AI Designer Tab -->
                        <div class="tab-pane fade show active" id="ai-designer">
                            <div class="ai-prompt-box">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="fw-bold"><i class="bi bi-robot me-2"></i>ChemFlow Ultimate - AI Architect Prompt</label>
                                    <button class="btn btn-light btn-sm" onclick="copyPrompt()"><i class="bi bi-clipboard"></i> Copy Prompt</button>
                                </div>
                                <textarea id="aiPromptText" class="form-control ai-prompt-text" readonly>
You are the **ChemFlow Ultimate JSON Architect**. Your mission: convert chemical 
mechanism descriptions into perfect, error-free JSON that utilizes 100% of the 
rendering engine's advanced capabilities.

═══════════════════════════════════════════════════════════════════════════════
CRITICAL OUTPUT RULES (MUST FOLLOW)
═══════════════════════════════════════════════════════════════════════════════

1. OUTPUT ONLY VALID JSON
   Markdown code blocks (```json ... ```)
   NO conversational text before/after JSON
   NO explanations or comments outside JSON
   START with { and END with }
   Proper escaping of quotes in strings

2. ID INTEGRITY (SACRED RULE)
   • Every molecule MUST have unique string "id"
   • Every atom MUST have unique string "id" 
   • Mechanism arrows reference EXACT atom IDs in "from"/"to"
   • Bracket "targets" reference EXACT molecule IDs

3. COORDINATE SYSTEM
   • Grid units: 1.0 = 45px on screen
   • Bond length: typically 1.0-1.5 units
   • Auto-layout: OMIT x,y properties entirely
   • Manual layout: Use decimal coordinates (e.g., 1.5, -0.866)

═══════════════════════════════════════════════════════════════════════════════
POWER FEATURES - USE THESE AGGRESSIVELY!
═══════════════════════════════════════════════════════════════════════════════

### A. INTELLIGENT COLOR SYSTEM

You are the visual designer. Apply colors strategically for maximum clarity:

ATOM COLORING:
  Oxygen/Electrophiles:    "#ef4444" (Red)
  Nitrogen/Nucleophiles:   "#3b82f6" (Blue) 
  Halogens/Leaving Groups: "#b91c1c" (Dark Red) or "#d97706" (Amber/Orange)
  Carbocations:            "#2563eb" (Bright Blue)
  Carbanions:              "#16a34a" (Green)
  Radicals:                "#a855f7" (Purple)
  Standard Carbons:        "#64748b" (Gray) or omit for default black

BOND COLORING:
  Breaking bonds:          "#ef4444" (Red)
  Forming bonds:           "#16a34a" (Green)
  Highlighted path:        "#d97706" (Amber)
  Standard:                omit for default black

MECHANISM ARROW COLORING:
  Nucleophilic attack:     "#3b82f6" (Blue)
  Leaving group:           "#ef4444" (Red)
  Rearrangement:           "#8b5cf6" (Purple)
  Proton transfer:         "#10b981" (Emerald)
  Standard:                "#2563eb" (Blue)

REACTION ARROW COLORING:
  Standard:                "#0f172a" (Black)
  Emphasis:                "#ef4444" (Red)
  Reversible:              "#3b82f6" (Blue)

COLOR SYNTAX:
{
  "atoms": [
    { "id": "o1", "symbol": "O", "x": 0, "y": 0, "color": "#ef4444" }
  ],
  "bonds": [
    { "from": "c1", "to": "o1", "type": "double", "color": "#ef4444" }
  ]
}
{
  "mechanism": [
    { "from": "nuc", "to": "elec", "curve": -40, "color": "#3b82f6" }
  ]
}
{
  "arrow": { "type": "forward", "text_above": "Heat", "color": "#ef4444" }
}

### B. AUTO-LAYOUT SYSTEM

Omit coordinates for automatic positioning:

EXAMPLE: Benzene Ring (No Coordinates!)
{
  "atoms": [
    { "id": "c1", "symbol": "C" },
    { "id": "c2", "symbol": "C" },
    { "id": "c3", "symbol": "C" },
    { "id": "c4", "symbol": "C" },
    { "id": "c5", "symbol": "C" },
    { "id": "c6", "symbol": "C" }
  ],
  "bonds": [
    { "from": "c1", "to": "c2", "type": "double" },
    { "from": "c2", "to": "c3", "type": "single" },
    { "from": "c3", "to": "c4", "type": "double" },
    { "from": "c4", "to": "c5", "type": "single" },
    { "from": "c5", "to": "c6", "type": "double" },
    { "from": "c6", "to": "c1", "type": "single" }
  ]
}

Engine automatically positions atoms in proper ring geometry!

### C. DYNAMIC BRACKETS

OLD WAY (Fixed coordinates):
{
  "brackets": [
    { "rect": [0, 0, 5, 3], "label": "‡" }
  ]
}

NEW WAY (Auto-wrapping):
{
  "brackets": [
    { 
      "targets": ["carbocation_intermediate"], 
      "label": "‡",
      "color": "#64748b"
    }
  ]
}

Brackets automatically wrap molecules even after auto-layout!

═══════════════════════════════════════════════════════════════════════════════
COMPLETE JSON SCHEMA REFERENCE
═══════════════════════════════════════════════════════════════════════════════

{
  "steps": [
    {
      "annotation": "HTML string with <b>, <em>, <br> tags for formatting",

      "reactants": [
        {
          "id": "unique_mol_id",
          "atoms": [
            {
              "id": "unique_atom_id",
              "symbol": "C|N|O|H|Cl|Br|etc",  // Use subscripts: CH₃, H₂O, NH₄
              "x": 0.0,                        // Optional (omit for auto-layout)
              "y": 0.0,                        // Optional (omit for auto-layout)
              "charge": "+|-|+2|-2",           // Optional
              "isotope": "13|14|2",            // Optional (superscript)
              "lonePairs": 0-4,                // Optional (integer)
              "color": "#HEXCODE"              // Optional (hex string)
            }
          ],
          "bonds": [
            {
              "from": "atom_id_1",
              "to": "atom_id_2",
              "type": "single|double|triple|wedge|dash|wavy",
              "color": "#HEXCODE"              // Optional
            }
          ]
        }
      ],

      "arrow": {
        "type": "forward|retro|resonance|eq",
        "text_above": "Reagents/Conditions",  // Optional
        "color": "#HEXCODE"                    // Optional
      },

      "mechanism": [                           // Optional (electron flow)
        {
          "from": "atom_id_source",
          "to": "atom_id_target",
          "curve": -40 to 40,                  // Negative = curve away
          "color": "#HEXCODE"                  // Optional
        }
      ],

      "brackets": [                            // Optional (transition states)
        {
          "targets": ["mol_id_1", "mol_id_2"], // NEW: Dynamic wrapping
          "label": "‡|TS|[Intermediate]",
          "color": "#HEXCODE"                  // Optional
        }
      ],

      "products": [
        // Same structure as reactants
      ]
    }
  ]
}

═══════════════════════════════════════════════════════════════════════════════
FEATURE COMPLETENESS CHECKLIST
═══════════════════════════════════════════════════════════════════════════════

BOND TYPES (Use all 6 when appropriate):
  ☐ "single"    - Regular single bond
  ☐ "double"    - Parallel double bond (3px separation)
  ☐ "triple"    - Triple bond (for C≡N, C≡C)
  ☐ "wedge"     - Solid wedge (coming out of page)
  ☐ "dash"      - Dashed wedge (going into page)
  ☐ "wavy"      - Wavy bond (racemic/unknown stereochemistry)

ARROW TYPES (4 types available):
  ☐ "forward"    - Standard reaction arrow →
  ☐ "retro"      - Retrosynthetic arrow ⇒
  ☐ "resonance"  - Double-headed arrow ↔
  ☐ "eq"         - Equilibrium arrows ⇌

ATOM FEATURES:
  ☐ Charges: "+", "-", "+2", "-2" (renders as ⊕, ⊖)
  ☐ Isotopes: "13", "14", "2" (superscript)
  ☐ Lone pairs: 0-4 (dot pairs)
  ☐ Subscripts: Use UTF-8 (CH₃, H₂O, NH₄⁺)
  ☐ Colors: Hex codes for emphasis

MECHANISM ARROWS:
  ☐ Curved arrows for electron flow
  ☐ "curve" property: negative (away) or positive (toward)
  ☐ Color-coded by arrow type
  ☐ Connect exact atom IDs

ANNOTATIONS:
  ☐ HTML formatting: <b>, <strong>, <em>, <br>
  ☐ Multi-line with <br> tags
  ☐ Reaction conditions, notes, explanations

═══════════════════════════════════════════════════════════════════════════════
COMMON ERRORS TO AVOID
═══════════════════════════════════════════════════════════════════════════════

RONG: Non-existent atom IDs in mechanism
{
  "mechanism": [
    { "from": "c1", "to": "c99", "curve": -40 }  // c99 doesn't exist!
  ]
}

CORRECT: Only reference atoms that exist
{
  "atoms": [
    { "id": "c1", ... },
    { "id": "c2", ... }
  ],
  "mechanism": [
    { "from": "c1", "to": "c2", "curve": -40 }  // Both exist
  ]
}

---

WRONG: Duplicate atom IDs
{
  "atoms": [
    { "id": "c1", ... },
    { "id": "c1", ... }  // DUPLICATE!
  ]
}

CORRECT: Unique IDs always
{
  "atoms": [
    { "id": "c1", ... },
    { "id": "c2", ... }
  ]
}

---

WRONG: Mixed auto/manual coordinates
{
  "atoms": [
    { "id": "c1", "x": 0, "y": 0 },
    { "id": "c2" }  // Missing x,y but c1 has them
  ]
}

CORRECT: All manual OR all auto
{
  "atoms": [
    { "id": "c1", "x": 0, "y": 0 },
    { "id": "c2", "x": 1.5, "y": 0 }
  ]
}

OR

{
  "atoms": [
    { "id": "c1" },  // Both omit x,y
    { "id": "c2" }
  ]
}

---

WRONG: Old bracket syntax with auto-layout
{
  "brackets": [
    { "rect": [0, 0, 5, 3], "label": "‡" }  // Breaks if atoms move!
  ]
}

CORRECT: New dynamic bracket syntax
{
  "brackets": [
    { "targets": ["intermediate_mol"], "label": "‡" }
  ]
}

═══════════════════════════════════════════════════════════════════════════════
BEST PRACTICES
═══════════════════════════════════════════════════════════════════════════════
MUST: 
   • In first step add the question similer thing no need of mechanishm . 
   • And in last step add final products no need need of mechanishm. 
   • And others steps inside these should be show each and every detail of mechanishm also try to take mediators as chemical if they are also reacting.

1. COLOR STRATEGY
   • Use red for electron-poor atoms (O, electrophiles)
   • Use blue for electron-rich atoms (N, nucleophiles)
   • Highlight reaction center with bright colors
   • Keep spectator atoms gray or default black

2. MECHANISM CLARITY
   • Show ALL electron-pushing arrows
   • Use negative curves for nucleophilic attack
   • Use positive curves for leaving groups
   • Color-code arrows by type (blue=nuc, red=leaving)

3. STEREOCHEMISTRY
   • Use wedge bonds for atoms coming out
   • Use dash bonds for atoms going in
   • Use wavy bonds for racemic/unknown centers
   • Add isotope labels for tracking (¹³C)

4. ANNOTATIONS
   • Explain WHAT happens in each step
   • Use <b> for step titles
   • Use <em> for emphasis
   • Use <br> for line breaks

5. TRANSITION STATES
   • Use dynamic brackets with "targets"
   • Label with "‡" for transition states
   • Label with custom text for intermediates
   • Add color for emphasis

═══════════════════════════════════════════════════════════════════════════════
FINAL CHECKLIST BEFORE OUTPUT
═══════════════════════════════════════════════════════════════════════════════

☐ JSON is valid (no syntax errors)
☐ NO code blocks or markdown
☐ All IDs are unique
☐ All mechanism "from"/"to" reference existing atoms
☐ All bracket "targets" reference existing molecules
☐ Coordinates are consistent (all manual OR all omitted)
☐ Colors enhance clarity (not random)
☐ Bond types match chemistry (wedge/dash for stereo)
☐ Annotations explain the chemistry
☐ Arrow types match reaction type

═══════════════════════════════════════════════════════════════════════════════

YOUR TASK:
Generate perfect ChemFlow JSON for the following mechanism. Use colors 
strategically to highlight reactive centers. Include all electron-pushing arrows.
Explain each step clearly in annotations.

MECHANISM TO GENERATE:
[USER WILL INSERT REACTION DESCRIPTION/IMAGE/TITLE HERE]

═══════════════════════════════════════════════════════════════════════════════
OUTPUT ONLY THE JSON - NO OTHER TEXT
═══════════════════════════════════════════════════════════════════════════════
</textarea>
                            </div>
                        </div>

                        <!-- JSON Input Tab -->
                        <div class="tab-pane fade" id="json-input">
                            <div class="d-flex flex-column gap-3">
                                <div style="position: relative;">
                                    <textarea class="code-editor" id="jsonInput" placeholder="Paste your JSON data structure here..."></textarea>
                                    <button onclick="pasteFromClipboard()" class="btn btn-sm btn-light" style="position: absolute; top: 10px; right: 10px; border: 1px solid #475569; color: #475569;">
                                        <i class="bi bi-clipboard-plus"></i> Paste & Clear
                                    </button>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn" onclick="loadComplexDemo()">
                                        <i class="bi bi-file-earmark-code"></i> Load Demo
                                    </button>
                                    <button class="btn btn-primary" onclick="parseAndRender()">
                                        <i class="bi bi-play-fill"></i> Render Engine
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const NS = "http://www.w3.org/2000/svg";

        // ==========================================
        // AUTO-LAYOUT EXTENSION MODULE
        // ==========================================
        class LayoutResolver {
            constructor(scale = 45) {
                this.scale = scale;
                this.BOND_LENGTH = 1.0;
            }

            resolve(data) {
                const enriched = JSON.parse(JSON.stringify(data));
                enriched.steps.forEach(step => {
                    step.reactants = step.reactants.map(mol => this.resolveMolecule(mol));
                    step.products = step.products.map(mol => this.resolveMolecule(mol));
                });
                return enriched;
            }

            resolveMolecule(mol) {
                if (!mol.atoms.some(a => a.x === undefined || a.y === undefined)) return mol;
                return this.autoLayoutMolecule(mol);
            }

            autoLayoutMolecule(mol) {
                const graph = this.buildGraph(mol);
                const rings = this.detectRings(graph);
                if (rings.length > 0) return this.layoutWithRings(mol, graph, rings);
                return this.layoutChain(mol, graph);
            }

            buildGraph(mol) {
                const graph = {};
                mol.atoms.forEach(atom => graph[atom.id] = {
                    atom: atom,
                    neighbors: []
                });
                mol.bonds.forEach(bond => {
                    if (graph[bond.from] && graph[bond.to]) {
                        graph[bond.from].neighbors.push(bond.to);
                        graph[bond.to].neighbors.push(bond.from);
                    }
                });
                return graph;
            }

            detectRings(graph) {
                return [];
            }

            layoutChain(mol, graph) {
                const positions = {};
                const placed = new Set();
                const longestPath = this.findLongestPath(graph);

                if (longestPath.length === 0) {
                    mol.atoms.forEach((atom, i) => {
                        atom.x = i;
                        atom.y = 0;
                    });
                    return mol;
                }

                longestPath.forEach((atomId, i) => {
                    positions[atomId] = {
                        x: i * 0.866,
                        y: (i % 2) * 0.5
                    };
                    placed.add(atomId);
                });

                longestPath.forEach((atomId) => {
                    const neighbors = graph[atomId].neighbors.filter(n => !placed.has(n));
                    neighbors.forEach((subId) => {
                        const base = positions[atomId];
                        positions[subId] = {
                            x: base.x,
                            y: base.y - 1
                        };
                        placed.add(subId);
                    });
                });

                mol.atoms.forEach(atom => {
                    if (positions[atom.id]) {
                        atom.x = positions[atom.id].x;
                        atom.y = positions[atom.id].y;
                    } else {
                        atom.x = 0;
                        atom.y = 0;
                    }
                });
                return mol;
            }

            findLongestPath(graph) {
                const ids = Object.keys(graph);
                return ids.length > 0 ? ids : [];
            }

            layoutWithRings(mol, graph, rings) {
                return mol;
            }
        }

        // ==========================================
        // CHEM ENGINE (With v2.0 Features)
        // ==========================================
        class ChemEngine {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.scale = 45;
                this.atomReg = {};
                this.layoutResolver = new LayoutResolver(this.scale);
            }

            initSVG(w, h) {
                this.container.innerHTML = '';
                this.svg = document.createElementNS(NS, "svg");
                this.svg.classList.add("chem-svg");
                this.svg.setAttribute("width", w);
                this.svg.setAttribute("height", h);
                this.defs = document.createElementNS(NS, "defs");
                this.createMarker("rxn-head", "#0f172a");
                this.createMarker("mech-head", "#2563eb");
                this.svg.appendChild(this.defs);
                this.layerMain = document.createElementNS(NS, "g");
                this.svg.appendChild(this.layerMain);
                this.container.appendChild(this.svg);
            }

            createMarker(id, color) {
                const m = document.createElementNS(NS, "marker");
                m.setAttribute("id", id);
                m.setAttribute("markerWidth", "10");
                m.setAttribute("markerHeight", "10");
                m.setAttribute("refX", "9");
                m.setAttribute("refY", "4");
                m.setAttribute("orient", "auto");
                const p = document.createElementNS(NS, "path");
                p.setAttribute("d", "M0,0 L10,4 L0,8 L2,4 z");
                p.setAttribute("fill", color);
                m.appendChild(p);
                this.defs.appendChild(m);
            }

            getMarker(color) {
                const id = `head-${color.replace('#', '')}`;
                if (!document.getElementById(id)) {
                    this.createMarker(id, color);
                }
                return `url(#${id})`;
            }

            render(data) {
                const enrichedData = this.layoutResolver.resolve(data);

                const stepBounds = [];
                enrichedData.steps.forEach(step => {
                    let minY = Infinity,
                        maxY = -Infinity;

                    step.reactants.forEach(mol => {
                        mol.atoms.forEach(a => {
                            if (a.y < minY) minY = a.y;
                            if (a.y > maxY) maxY = a.y;
                        });
                    });

                    step.products.forEach(mol => {
                        mol.atoms.forEach(a => {
                            if (a.y < minY) minY = a.y;
                            if (a.y > maxY) maxY = a.y;
                        });
                    });

                    const gridHeight = maxY - minY;
                    const pixelHeight = gridHeight * this.scale;
                    const totalPadding = 180;

                    stepBounds.push({
                        minY: minY,
                        maxY: maxY,
                        gridHeight: gridHeight,
                        pixelHeight: pixelHeight,
                        totalHeight: Math.max(350, pixelHeight + totalPadding)
                    });
                });

                const totalH = stepBounds.reduce((sum, b) => sum + b.totalHeight, 0) + 100;
                this.initSVG(2500, totalH);

                const labelColWidth = 120;
                let cursorY = 80;

                enrichedData.steps.forEach((step, i) => {
                    const stepInfo = stepBounds[i];
                    const verticalOffset = (stepInfo.totalHeight - stepInfo.pixelHeight) / 2;
                    const adjustedCursorY = cursorY + verticalOffset;

                    this.drawText(`STEP ${i+1}`, 40, cursorY, "label-text");
                    this.drawDivider(labelColWidth, cursorY - 20, labelColWidth, cursorY + stepInfo.totalHeight - 60);

                    let cursorX = labelColWidth + 20;
                    const moleculeBounds = {};

                    step.reactants.forEach(mol => {
                        const bounds = this.drawMolecule(mol, cursorX, adjustedCursorY);
                        moleculeBounds[mol.id] = bounds;
                        cursorX += (bounds.width / this.scale) * this.scale + 60;
                    });

                    this.drawReactionArrow(cursorX, adjustedCursorY, step.arrow);

                    if (step.mechanism) {
                        step.mechanism.forEach(m => this.drawMechArrow(m));
                    }

                    cursorX += 120;

                    step.products.forEach(mol => {
                        const bounds = this.drawMolecule(mol, cursorX, adjustedCursorY);
                        moleculeBounds[mol.id] = bounds;
                        cursorX += (bounds.width / this.scale) * this.scale + 60;
                    });

                    if (step.brackets) {
                        step.brackets.forEach(b => {
                            if (b.targets) {
                                this.drawDynamicBracket(b, moleculeBounds);
                            } else if (b.rect) {
                                this.drawBracket(b, labelColWidth + 20, adjustedCursorY);
                            }
                        });
                    }

                    if (step.annotation) {
                        this.drawAnnotationBox(step.annotation, cursorX + 20, cursorY - 60);
                    }

                    cursorY += stepInfo.totalHeight;
                });
            }

            drawDynamicBracket(b, moleculeBounds) {
                let minX = Infinity,
                    maxX = -Infinity,
                    minY = Infinity,
                    maxY = -Infinity;
                let found = false;

                b.targets.forEach(molId => {
                    const bounds = moleculeBounds[molId];
                    if (bounds) {
                        if (bounds.minX < minX) minX = bounds.minX;
                        if (bounds.maxX > maxX) maxX = bounds.maxX;
                        if (bounds.minY < minY) minY = bounds.minY;
                        if (bounds.maxY > maxY) maxY = bounds.maxY;
                        found = true;
                    }
                });

                if (found) {
                    const pad = 30;
                    const rect = {
                        x: minX - pad,
                        y: minY - pad,
                        w: (maxX - minX) + (pad * 2),
                        h: (maxY - minY) + (pad * 2)
                    };

                    const g = document.createElementNS(NS, "g");
                    g.setAttribute("opacity", "0.8");
                    const path = document.createElementNS(NS, "path");
                    const dStr = `M${rect.x+10},${rect.y} L${rect.x},${rect.y} L${rect.x},${rect.y+rect.h} L${rect.x+10},${rect.y+rect.h} ` +
                        `M${rect.x+rect.w-10},${rect.y} L${rect.x+rect.w},${rect.y} L${rect.x+rect.w},${rect.y+rect.h} L${rect.x+rect.w-10},${rect.y+rect.h}`;
                    path.setAttribute("d", dStr);
                    path.setAttribute("stroke", b.color || "#0f172a");
                    path.setAttribute("stroke-width", "2");
                    path.setAttribute("fill", "none");
                    g.appendChild(path);

                    if (b.label) {
                        const t = document.createElementNS(NS, "text");
                        t.textContent = b.label;
                        t.setAttribute("x", rect.x + rect.w + 5);
                        t.setAttribute("y", rect.y + 20);
                        t.setAttribute("class", "ts-symbol");
                        if (b.color) t.setAttribute("fill", b.color);
                        g.appendChild(t);
                    }
                    this.layerMain.appendChild(g);
                }
            }

            drawMolecule(mol, offX, offY) {
                const xs = mol.atoms.map(a => a.x);
                const ys = mol.atoms.map(a => a.y);
                const minX_grid = Math.min(...xs);

                let minPxX = Infinity,
                    maxPxX = -Infinity,
                    minPxY = Infinity,
                    maxPxY = -Infinity;

                mol.atoms.forEach(a => {
                    const px = (a.x - minX_grid) * this.scale + offX;
                    const py = (a.y * this.scale) + offY;
                    this.atomReg[a.id] = {
                        x: px,
                        y: py
                    };

                    if (px < minPxX) minPxX = px;
                    if (px > maxPxX) maxPxX = px;
                    if (py < minPxY) minPxY = py;
                    if (py > maxPxY) maxPxY = py;
                });

                mol.bonds.forEach(b => {
                    const p1 = this.atomReg[b.from];
                    const p2 = this.atomReg[b.to];
                    if (p1 && p2) this.drawBond(p1, p2, b);
                });

                mol.atoms.forEach(a => {
                    const p = this.atomReg[a.id];
                    this.drawAtom(a, p.x, p.y);
                });

                return {
                    width: (Math.max(...xs) - minX_grid) * this.scale,
                    minX: minPxX,
                    maxX: maxPxX,
                    minY: minPxY,
                    maxY: maxPxY
                };
            }

            drawAtom(a, x, y) {
                const g = document.createElementNS(NS, "g");
                g.setAttribute("transform", `translate(${x},${y})`);

                const color = a.color || "#0f172a";

                const content = a.symbol.replace(/(\d+)/g, '<tspan dy="4" font-size="0.75em">$1</tspan><tspan dy="-4" font-size="1em"> </tspan>');

                const h = document.createElementNS(NS, "text");
                h.innerHTML = content;
                h.className.baseVal = "atom-halo";

                const t = document.createElementNS(NS, "text");
                t.innerHTML = content;
                t.className.baseVal = "atom-text";
                t.setAttribute("fill", color);

                g.appendChild(h);
                g.appendChild(t);

                if (a.charge) {
                    const c = document.createElementNS(NS, "text");
                    c.textContent = a.charge === "+" ? "⊕" : (a.charge === "-" ? "⊖" : a.charge);
                    c.setAttribute("x", 12);
                    c.setAttribute("y", -8);
                    c.setAttribute("fill", a.charge.includes("+") ? "#2563eb" : "#dc2626");
                    c.setAttribute("font-size", "12");
                    g.appendChild(c);
                }

                if (a.isotope) {
                    const iso = document.createElementNS(NS, "text");
                    iso.textContent = a.isotope;
                    iso.setAttribute("x", -10);
                    iso.setAttribute("y", -6);
                    iso.setAttribute("font-size", "10");
                    iso.setAttribute("fill", color);
                    g.appendChild(iso);
                }

                if (a.lonePairs) this.drawLonePairs(g, a.lonePairs, color);
                this.layerMain.appendChild(g);
            }

            drawLonePairs(group, count, color) {
                for (let i = 0; i < count; i++) {
                    const c1 = document.createElementNS(NS, "circle");
                    c1.setAttribute("r", 1.5);
                    c1.setAttribute("cx", -4 + i * 8);
                    c1.setAttribute("cy", -12);
                    c1.setAttribute("fill", color);
                    const c2 = document.createElementNS(NS, "circle");
                    c2.setAttribute("r", 1.5);
                    c2.setAttribute("cx", -1 + i * 8);
                    c2.setAttribute("cy", -12);
                    c2.setAttribute("fill", color);
                    group.appendChild(c1);
                    group.appendChild(c2);
                }
            }

            drawBond(p1, p2, b) {
                const color = b.color || "#0f172a";
                const dx = p2.x - p1.x,
                    dy = p2.y - p1.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const nx = -dy / dist,
                    ny = dx / dist;
                const pad = 14;
                const sx = p1.x + (dx / dist) * pad,
                    sy = p1.y + (dy / dist) * pad;
                const ex = p2.x - (dx / dist) * pad,
                    ey = p2.y - (dy / dist) * pad;

                const path = document.createElementNS(NS, "path");
                let d = "";

                if (b.type === "double") {
                    const off = 3;
                    d = `M${sx+nx*off},${sy+ny*off} L${ex+nx*off},${ey+ny*off} M${sx-nx*off},${sy-ny*off} L${ex-nx*off},${ey-ny*off}`;
                } else if (b.type === "triple") {
                    const off = 3;
                    d = `M${sx},${sy} L${ex},${ey} M${sx+nx*off},${sy+ny*off} L${ex+nx*off},${ey+ny*off} M${sx-nx*off},${sy-ny*off} L${ex-nx*off},${ey-ny*off}`;
                } else if (b.type === "wedge") {
                    const w = 4;
                    d = `M${sx},${sy} L${ex+nx*w},${ey+ny*w} L${ex-nx*w},${ey-ny*w} Z`;
                    path.setAttribute("fill", color);
                    path.setAttribute("stroke", "none");
                } else if (b.type === "wavy") {
                    const steps = 6;
                    d = `M${sx},${sy}`;
                    for (let i = 1; i <= steps; i++) {
                        const t = i / steps;
                        const tx = sx + (ex - sx) * t;
                        const ty = sy + (ey - sy) * t;
                        const amp = (i % 2 === 0 ? 3 : -3);
                        d += ` L${tx + nx*amp},${ty + ny*amp}`;
                    }
                } else {
                    d = `M${sx},${sy} L${ex},${ey}`;
                }

                if (b.type !== "wedge") {
                    path.setAttribute("d", d);
                    path.setAttribute("stroke", color);
                    path.setAttribute("stroke-width", "2.5");
                    path.setAttribute("stroke-linecap", "round");
                    path.setAttribute("fill", "none");
                    if (b.type === "dash") path.setAttribute("stroke-dasharray", "5 3");
                } else {
                    path.setAttribute("d", d);
                }

                this.layerMain.insertBefore(path, this.layerMain.firstChild);
            }

            drawReactionArrow(x, y, arrow) {
                const w = 100;
                const color = arrow.color || "#0f172a";
                const marker = this.getMarker(color);

                const g = document.createElementNS(NS, "g");
                let p = document.createElementNS(NS, "path");
                p.setAttribute("stroke", color);
                p.setAttribute("stroke-width", "1.5");
                p.setAttribute("fill", "none");

                if (arrow.type === "eq") {
                    const h = 4;
                    const p1 = p.cloneNode();
                    p1.setAttribute("d", `M${x},${y-h} L${x+w},${y-h}`);
                    p1.setAttribute("marker-end", marker);
                    const p2 = p.cloneNode();
                    p2.setAttribute("d", `M${x+w},${y+h} L${x},${y+h}`);
                    p2.setAttribute("marker-end", marker);
                    g.appendChild(p1);
                    g.appendChild(p2);
                    p = null;
                } else if (arrow.type === "resonance") {
                    p.setAttribute("d", `M${x},${y} L${x+w},${y}`);
                    p.setAttribute("marker-start", marker);
                    p.setAttribute("marker-end", marker);
                } else {
                    p.setAttribute("d", `M${x},${y} L${x+w},${y}`);
                    p.setAttribute("marker-end", marker);
                }
                if (p) g.appendChild(p);

                if (arrow.text_above) {
                    const t = document.createElementNS(NS, "text");
                    t.textContent = arrow.text_above;
                    t.setAttribute("x", x + w / 2);
                    t.setAttribute("y", y - 15);
                    t.setAttribute("text-anchor", "middle");
                    t.setAttribute("font-size", "11");
                    t.setAttribute("fill", color);
                    g.appendChild(t);
                }
                this.layerMain.appendChild(g);
            }

            drawMechArrow(mech) {
                const p1 = this.atomReg[mech.from];
                const p2 = this.atomReg[mech.to];
                if (!p1 || !p2) return;
                const color = mech.color || "#2563eb";

                const mx = (p1.x + p2.x) / 2,
                    my = (p1.y + p2.y) / 2;
                const dx = p2.x - p1.x,
                    dy = p2.y - p1.y;
                const nx = -dy / Math.sqrt(dx * dx + dy * dy),
                    ny = dx / Math.sqrt(dx * dx + dy * dy);
                const h = mech.curve || -40;
                const cx = mx + nx * h,
                    cy = my + ny * h;

                const path = document.createElementNS(NS, "path");
                path.setAttribute("d", `M${p1.x},${p1.y} Q${cx},${cy} ${p2.x},${p2.y}`);
                path.setAttribute("stroke", color);
                path.setAttribute("stroke-width", "1.5");
                path.setAttribute("fill", "none");
                path.setAttribute("marker-end", this.getMarker(color));
                this.layerMain.appendChild(path);
            }

            drawBracket(b, offX, offY) {
                const x = b.rect[0] * this.scale + offX - 20;
                const y = b.rect[1] * this.scale + offY - 20;
                const w = b.rect[2] * this.scale + 40;
                const h = b.rect[3] * this.scale + 40;
                const g = document.createElementNS(NS, "g");
                g.setAttribute("opacity", "0.8");
                const path = document.createElementNS(NS, "path");
                const d = 10;
                path.setAttribute("d", `M${x+d},${y} L${x},${y} L${x},${y+h} L${x+d},${y+h} M${x+w-d},${y} L${x+w},${y} L${x+w},${y+h} L${x+w-d},${y+h}`);
                path.setAttribute("stroke", b.color || "#0f172a");
                path.setAttribute("stroke-width", "2");
                path.setAttribute("fill", "none");
                g.appendChild(path);
                if (b.label) {
                    const t = document.createElementNS(NS, "text");
                    t.textContent = b.label;
                    t.setAttribute("x", x + w + 5);
                    t.setAttribute("y", y + 20);
                    t.setAttribute("class", "ts-symbol");
                    g.appendChild(t);
                }
                this.layerMain.appendChild(g);
            }

            drawText(str, x, y, cls) {
                const t = document.createElementNS(NS, "text");
                t.textContent = str;
                t.setAttribute("x", x);
                t.setAttribute("y", y);
                t.setAttribute("class", cls);
                this.layerMain.appendChild(t);
            }

            drawDivider(x1, y1, x2, y2) {
                const l = document.createElementNS(NS, "line");
                l.setAttribute("x1", x1);
                l.setAttribute("x2", x2);
                l.setAttribute("y1", y1);
                l.setAttribute("y2", y2);
                l.setAttribute("stroke", "#e2e8f0");
                l.setAttribute("stroke-width", "2");
                this.layerMain.appendChild(l);
            }

            drawAnnotationBox(text, x, y) {
                const w = 250,
                    h = 200;
                const g = document.createElementNS(NS, "g");
                const fo = document.createElementNS(NS, "foreignObject");
                fo.setAttribute("x", x);
                fo.setAttribute("y", y);
                fo.setAttribute("width", w);
                fo.setAttribute("height", h);
                const div = document.createElement("div");
                div.style.cssText = "padding:15px; font-size:14px; color:#475569; overflow-y:auto; height:100%; font-family:'Segoe UI',sans-serif; background:#f8fafc; border:1px solid #cbd5e1; border-radius:8px;";
                div.innerHTML = text;
                fo.appendChild(div);
                g.appendChild(fo);
                this.layerMain.appendChild(g);
            }
        }

        const engine = new ChemEngine("canvas-container");

        // ===== UTILITY FUNCTIONS =====
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('jsonInput').value = '';
                document.getElementById('jsonInput').value = text;
                showNotification('Content pasted successfully!', 'success');
            } catch (err) {
                document.getElementById('jsonInput').value = '';
                document.getElementById('jsonInput').focus();
                showNotification('Please use Ctrl+V (Cmd+V) to paste', 'info', 4000);
            }
        }

        function copyPrompt() {
            const promptText = document.getElementById('aiPromptText');
            navigator.clipboard.writeText(promptText.value).then(() => {
                showNotification('AI Prompt copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy prompt', 'error');
            });
        }

        function loadComplexDemo() {
            const data = {
                "steps": [{
                        "annotation": "<b>Step 1: Leaving Group Departs</b><br>C-Br bond breaks. Bromine (red) takes electrons.",
                        "reactants": [{
                            "id": "start_mol",
                            "atoms": [{
                                    "id": "c1",
                                    "symbol": "CH₃",
                                    "x": 0,
                                    "y": 0,
                                    "color": "#64748b"
                                },
                                {
                                    "id": "c2",
                                    "symbol": "C",
                                    "x": 1.5,
                                    "y": 0,
                                    "isotope": "13",
                                    "color": "#64748b"
                                },
                                {
                                    "id": "h2",
                                    "symbol": "H",
                                    "x": 1.5,
                                    "y": 1,
                                    "color": "#94a3b8"
                                },
                                {
                                    "id": "br",
                                    "symbol": "Br",
                                    "x": 2.5,
                                    "y": -1,
                                    "lonePairs": 3,
                                    "color": "#b91c1c"
                                },
                                {
                                    "id": "c3",
                                    "symbol": "C",
                                    "x": -1.5,
                                    "y": 0,
                                    "color": "#64748b"
                                },
                                {
                                    "id": "h3",
                                    "symbol": "H",
                                    "x": -1.5,
                                    "y": 1,
                                    "color": "#94a3b8"
                                },
                                {
                                    "id": "c4",
                                    "symbol": "CH₃",
                                    "x": -2.5,
                                    "y": -1,
                                    "color": "#64748b"
                                }
                            ],
                            "bonds": [{
                                    "from": "c1",
                                    "to": "c2",
                                    "type": "single"
                                },
                                {
                                    "from": "c2",
                                    "to": "h2",
                                    "type": "dash"
                                },
                                {
                                    "from": "c2",
                                    "to": "br",
                                    "type": "wedge",
                                    "color": "#b91c1c"
                                },
                                {
                                    "from": "c1",
                                    "to": "c3",
                                    "type": "single"
                                },
                                {
                                    "from": "c3",
                                    "to": "h3",
                                    "type": "single"
                                },
                                {
                                    "from": "c3",
                                    "to": "c4",
                                    "type": "single"
                                }
                            ]
                        }],
                        "arrow": {
                            "type": "forward",
                            "text_above": "Slow",
                            "color": "#b91c1c"
                        },
                        "products": [{
                                "id": "carbocation",
                                "atoms": [{
                                        "id": "pc1",
                                        "symbol": "CH₃",
                                        "x": 0,
                                        "y": 0
                                    },
                                    {
                                        "id": "pc2",
                                        "symbol": "C",
                                        "x": 1.5,
                                        "y": 0,
                                        "charge": "+",
                                        "isotope": "13",
                                        "color": "#2563eb"
                                    },
                                    {
                                        "id": "ph2",
                                        "symbol": "H",
                                        "x": 1.5,
                                        "y": 1
                                    },
                                    {
                                        "id": "pc3",
                                        "symbol": "C",
                                        "x": -1.5,
                                        "y": 0
                                    },
                                    {
                                        "id": "ph3",
                                        "symbol": "H",
                                        "x": -1.5,
                                        "y": 1
                                    },
                                    {
                                        "id": "pc4",
                                        "symbol": "CH₃",
                                        "x": -2.5,
                                        "y": -1
                                    }
                                ],
                                "bonds": [{
                                        "from": "pc1",
                                        "to": "pc2",
                                        "type": "single"
                                    },
                                    {
                                        "from": "pc2",
                                        "to": "ph2",
                                        "type": "single"
                                    },
                                    {
                                        "from": "pc1",
                                        "to": "pc3",
                                        "type": "single"
                                    },
                                    {
                                        "from": "pc3",
                                        "to": "ph3",
                                        "type": "single"
                                    },
                                    {
                                        "from": "pc3",
                                        "to": "pc4",
                                        "type": "single"
                                    }
                                ]
                            },
                            {
                                "id": "bromide",
                                "atoms": [{
                                    "id": "pbr",
                                    "symbol": "Br",
                                    "x": 0,
                                    "y": 0,
                                    "charge": "-",
                                    "lonePairs": 4,
                                    "color": "#b91c1c"
                                }],
                                "bonds": []
                            }
                        ]
                    },
                    {
                        "annotation": "<b>Step 2: Hydride Shift</b><br>Secondary carbocation (blue) rearranges to tertiary via hydride (orange) migration.",
                        "reactants": [{
                            "id": "carbocation_2",
                            "atoms": [{
                                    "id": "rc1",
                                    "symbol": "CH₃",
                                    "x": 0,
                                    "y": 0
                                },
                                {
                                    "id": "rc2",
                                    "symbol": "C",
                                    "x": 1.5,
                                    "y": 0,
                                    "charge": "+",
                                    "isotope": "13",
                                    "color": "#2563eb"
                                },
                                {
                                    "id": "rh2",
                                    "symbol": "H",
                                    "x": 1.5,
                                    "y": 1
                                },
                                {
                                    "id": "rc3",
                                    "symbol": "C",
                                    "x": -1.5,
                                    "y": 0
                                },
                                {
                                    "id": "rh3",
                                    "symbol": "H",
                                    "x": -1.5,
                                    "y": 1,
                                    "color": "#d97706"
                                },
                                {
                                    "id": "rc4",
                                    "symbol": "CH₃",
                                    "x": -2.5,
                                    "y": -1
                                }
                            ],
                            "bonds": [{
                                    "from": "rc1",
                                    "to": "rc2",
                                    "type": "single"
                                },
                                {
                                    "from": "rc2",
                                    "to": "rh2",
                                    "type": "single"
                                },
                                {
                                    "from": "rc1",
                                    "to": "rc3",
                                    "type": "single"
                                },
                                {
                                    "from": "rc3",
                                    "to": "rh3",
                                    "type": "single",
                                    "color": "#d97706"
                                },
                                {
                                    "from": "rc3",
                                    "to": "rc4",
                                    "type": "single"
                                }
                            ]
                        }],
                        "mechanism": [{
                            "from": "rh3",
                            "to": "rc2",
                            "curve": 30,
                            "color": "#d97706"
                        }],
                        "arrow": {
                            "type": "forward",
                            "text_above": "Rearrange"
                        },
                        "products": [{
                            "id": "carbocation_tert",
                            "atoms": [{
                                    "id": "tc1",
                                    "symbol": "C",
                                    "x": 0,
                                    "y": 0,
                                    "charge": "+",
                                    "color": "#2563eb"
                                },
                                {
                                    "id": "tc2",
                                    "symbol": "C",
                                    "x": 1.5,
                                    "y": 0,
                                    "isotope": "13"
                                },
                                {
                                    "id": "th2a",
                                    "symbol": "H",
                                    "x": 1.5,
                                    "y": 1
                                },
                                {
                                    "id": "th2b",
                                    "symbol": "H",
                                    "x": 2.5,
                                    "y": -0.5,
                                    "color": "#d97706"
                                },
                                {
                                    "id": "tc3",
                                    "symbol": "CH₃",
                                    "x": -1,
                                    "y": -1
                                },
                                {
                                    "id": "tc4",
                                    "symbol": "CH₃",
                                    "x": -1,
                                    "y": 1
                                }
                            ],
                            "bonds": [{
                                    "from": "tc1",
                                    "to": "tc2",
                                    "type": "single"
                                },
                                {
                                    "from": "tc2",
                                    "to": "th2a",
                                    "type": "single"
                                },
                                {
                                    "from": "tc2",
                                    "to": "th2b",
                                    "type": "single",
                                    "color": "#d97706"
                                },
                                {
                                    "from": "tc1",
                                    "to": "tc3",
                                    "type": "single"
                                },
                                {
                                    "from": "tc1",
                                    "to": "tc4",
                                    "type": "single"
                                }
                            ]
                        }],
                        "brackets": [{
                            "targets": ["carbocation_tert"],
                            "label": "‡",
                            "color": "#64748b"
                        }]
                    },
                    {
                        "annotation": "<b>Step 3: Nucleophilic Attack</b><br>Water (red) attacks carbocation (blue).",
                        "reactants": [{
                                "id": "carbocation_3",
                                "atoms": [{
                                        "id": "rc_t",
                                        "symbol": "C",
                                        "x": 0,
                                        "y": 0,
                                        "charge": "+",
                                        "color": "#2563eb"
                                    },
                                    {
                                        "id": "rc_i",
                                        "symbol": "C",
                                        "x": 1.5,
                                        "y": 0,
                                        "isotope": "13"
                                    },
                                    {
                                        "id": "rha",
                                        "symbol": "H",
                                        "x": 1.5,
                                        "y": 1
                                    },
                                    {
                                        "id": "rhb",
                                        "symbol": "H",
                                        "x": 2.5,
                                        "y": -0.5
                                    },
                                    {
                                        "id": "rm1",
                                        "symbol": "CH₃",
                                        "x": -1,
                                        "y": -1
                                    },
                                    {
                                        "id": "rm2",
                                        "symbol": "CH₃",
                                        "x": -1,
                                        "y": 1
                                    }
                                ],
                                "bonds": [{
                                        "from": "rc_t",
                                        "to": "rc_i",
                                        "type": "single"
                                    },
                                    {
                                        "from": "rc_i",
                                        "to": "rha",
                                        "type": "single"
                                    },
                                    {
                                        "from": "rc_i",
                                        "to": "rhb",
                                        "type": "single"
                                    },
                                    {
                                        "from": "rc_t",
                                        "to": "rm1",
                                        "type": "single"
                                    },
                                    {
                                        "from": "rc_t",
                                        "to": "rm2",
                                        "type": "single"
                                    }
                                ]
                            },
                            {
                                "id": "water",
                                "atoms": [{
                                        "id": "w_o",
                                        "symbol": "O",
                                        "x": -3,
                                        "y": 0,
                                        "lonePairs": 2,
                                        "color": "#ef4444"
                                    },
                                    {
                                        "id": "w_h1",
                                        "symbol": "H",
                                        "x": -3.5,
                                        "y": -0.5
                                    },
                                    {
                                        "id": "w_h2",
                                        "symbol": "H",
                                        "x": -3.5,
                                        "y": 0.5
                                    }
                                ],
                                "bonds": [{
                                        "from": "w_o",
                                        "to": "w_h1",
                                        "type": "single"
                                    },
                                    {
                                        "from": "w_o",
                                        "to": "w_h2",
                                        "type": "single"
                                    }
                                ]
                            }
                        ],
                        "mechanism": [{
                            "from": "w_o",
                            "to": "rc_t",
                            "curve": -45,
                            "color": "#ef4444"
                        }],
                        "arrow": {
                            "type": "forward",
                            "text_above": "Fast"
                        },
                        "products": [{
                            "id": "oxonium",
                            "atoms": [{
                                    "id": "p_c1",
                                    "symbol": "C",
                                    "x": 0,
                                    "y": 0
                                },
                                {
                                    "id": "p_c2",
                                    "symbol": "C",
                                    "x": 1.5,
                                    "y": 0,
                                    "isotope": "13"
                                },
                                {
                                    "id": "p_h2a",
                                    "symbol": "H",
                                    "x": 1.5,
                                    "y": 1
                                },
                                {
                                    "id": "p_h2b",
                                    "symbol": "H",
                                    "x": 2.5,
                                    "y": -0.5
                                },
                                {
                                    "id": "p_m1",
                                    "symbol": "CH₃",
                                    "x": -1,
                                    "y": -1
                                },
                                {
                                    "id": "p_m2",
                                    "symbol": "CH₃",
                                    "x": -1,
                                    "y": 1
                                },
                                {
                                    "id": "p_o",
                                    "symbol": "O",
                                    "x": -2.5,
                                    "y": 0,
                                    "charge": "+",
                                    "color": "#ef4444"
                                },
                                {
                                    "id": "p_h1",
                                    "symbol": "H",
                                    "x": -3,
                                    "y": -0.5
                                },
                                {
                                    "id": "p_h2",
                                    "symbol": "H",
                                    "x": -3,
                                    "y": 0.5
                                }
                            ],
                            "bonds": [{
                                    "from": "p_c1",
                                    "to": "p_c2",
                                    "type": "single"
                                },
                                {
                                    "from": "p_c2",
                                    "to": "p_h2a",
                                    "type": "single"
                                },
                                {
                                    "from": "p_c2",
                                    "to": "p_h2b",
                                    "type": "single"
                                },
                                {
                                    "from": "p_c1",
                                    "to": "p_m1",
                                    "type": "single"
                                },
                                {
                                    "from": "p_c1",
                                    "to": "p_m2",
                                    "type": "single"
                                },
                                {
                                    "from": "p_c1",
                                    "to": "p_o",
                                    "type": "single",
                                    "color": "#16a34a"
                                },
                                {
                                    "from": "p_o",
                                    "to": "p_h1",
                                    "type": "single"
                                },
                                {
                                    "from": "p_o",
                                    "to": "p_h2",
                                    "type": "single"
                                }
                            ]
                        }]
                    }
                ]
            };

            document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
        }

        function parseAndRender() {
            try {
                const jsonText = document.getElementById('jsonInput').value.trim();
                const data = JSON.parse(jsonText);
                engine.render(data);
                const modal = bootstrap.Modal.getInstance(document.getElementById('dataModal'));
                if (modal) modal.hide();
                showNotification('Mechanism rendered successfully!', 'success');
            } catch (err) {
                showNotification('JSON Parse Error: ' + err.message, 'error', 5000);
            }
        }

        function openModal() {
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();
        }

        function showNotification(message, type = 'info', duration = 1000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `custom-toast toast-${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-${type === 'success' ? 'check-circle-fill' : type === 'error' ? 'exclamation-triangle-fill' : 'info-circle-fill'}" style="font-size: 1.5rem; color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'}"></i>
                    <div style="flex: 1;">${message}</div>
                </div>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s, transform 0.3s';
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        (function initFullscreenControl() {
            // 1. Define the CSS styles
            const css = `
        #cf-fullscreen-btn {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 48px;
            height: 48px;
            background-color: rgba(15, 23, 42, 0.8); /* Slate-900 with opacity */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0;
            outline: none;
            color: #fff;
        }

        /* Hover effect */
        #cf-fullscreen-btn:hover {
            transform: scale(1.1);
            background-color: rgba(15, 23, 42, 1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        /* Click/Active effect */
        #cf-fullscreen-btn:active {
            transform: scale(0.95);
        }

        /* SVG Icon styling */
        #cf-fullscreen-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            pointer-events: none;
        }

        /* Hide on small screens (< 500px) */
        @media (max-width: 499px) {
            #cf-fullscreen-btn { display: none !important; }
        }
    `;

            // 2. Inject CSS into head
            const style = document.createElement('style');
            style.appendChild(document.createTextNode(css));
            document.head.appendChild(style);

            // 3. Create the Button
            const btn = document.createElement('button');
            btn.id = 'cf-fullscreen-btn';
            btn.setAttribute('aria-label', 'Toggle Fullscreen');
            btn.title = "Toggle Fullscreen";

            // Icons (Material Design)
            const iconEnter = '<svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>';
            const iconExit = '<svg viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>';

            // Set initial icon
            btn.innerHTML = iconEnter;

            // 4. Toggle Logic
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.warn(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            };

            // 5. Update icon based on state (handles ESC key press too)
            const updateIcon = () => {
                btn.innerHTML = document.fullscreenElement ? iconExit : iconEnter;
            };

            // 6. Add Event Listeners
            btn.addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', updateIcon);

            // 7. Append to DOM
            document.body.appendChild(btn);

        })();
        // Load demo on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadComplexDemo();
            parseAndRender();
        });
    </script>

</body>

</html>
